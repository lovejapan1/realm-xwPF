name: Update Realm Version

on:
  schedule:
    - cron: '0 * * * *'  # æ¯å°æ—¶è¿è¡Œä¸€æ¬¡
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  update-realm-version:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get latest realm version
        id: get-version
        run: |
          set -e
          
          # è·å–æœ€æ–°ç‰ˆæœ¬ï¼Œv*.*.*æ ¼å¼
          echo "æ­£åœ¨è·å–realmæœ€æ–°ç‰ˆæœ¬..."
          LATEST_RAW=$(curl -s --connect-timeout 10 --max-time 30 \
            "https://api.github.com/repos/zhboner/realm/releases/latest" | \
            jq -r '.tag_name // empty')
          
          # æ£€æŸ¥APIè°ƒç”¨æ˜¯å¦æˆåŠŸ
          if [ -z "$LATEST_RAW" ]; then
            echo "âŒ GitHub APIè°ƒç”¨å¤±è´¥ï¼Œè·³è¿‡æœ¬æ¬¡æ£€æŸ¥"
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # éªŒè¯ç‰ˆæœ¬å·æ ¼å¼ v*.*.*
          if [[ ! "$LATEST_RAW" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ ç‰ˆæœ¬å·æ ¼å¼ä¸ç¬¦åˆv*.*.*ï¼Œè·³è¿‡: $LATEST_RAW"
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "âœ… æ£€æµ‹åˆ°æœ€æ–°ç‰ˆæœ¬: $LATEST_RAW"
          echo "latest_version=$LATEST_RAW" >> $GITHUB_OUTPUT

          # ä»è„šæœ¬ä¸­æå–å½“å‰ç‰ˆæœ¬å·
          CURRENT_VERSION=""
          if [ -f "xwPF.sh" ]; then
            CURRENT_VERSION=$(grep '^REALM_VERSION=' xwPF.sh | cut -d'"' -f2)
          fi

          if [ -z "$CURRENT_VERSION" ]; then
            echo "âŒ æ— æ³•ä»è„šæœ¬ä¸­æå–å½“å‰ç‰ˆæœ¬å·"
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "âœ… å½“å‰ç‰ˆæœ¬: $CURRENT_VERSION"
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

          # æå–å½“å‰è„šæœ¬ç‰ˆæœ¬å·å¹¶è®¡ç®—æ–°ç‰ˆæœ¬
          CURRENT_SCRIPT_VERSION=$(grep '^SCRIPT_VERSION=' xwPF.sh | cut -d'"' -f2)
          if [[ "$CURRENT_SCRIPT_VERSION" =~ ^v([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
            MAJOR=${BASH_REMATCH[1]}
            MINOR=${BASH_REMATCH[2]}
            PATCH=${BASH_REMATCH[3]}
            NEW_PATCH=$((PATCH + 1))
            NEW_SCRIPT_VERSION="v${MAJOR}.${MINOR}.${NEW_PATCH}"
            echo "âœ… è„šæœ¬ç‰ˆæœ¬: $CURRENT_SCRIPT_VERSION -> $NEW_SCRIPT_VERSION"
            echo "new_script_version=$NEW_SCRIPT_VERSION" >> $GITHUB_OUTPUT
          else
            echo "âŒ æ— æ³•è§£æè„šæœ¬ç‰ˆæœ¬å·æ ¼å¼"
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # æ¯”è¾ƒç‰ˆæœ¬å·
          if [ "$LATEST_RAW" = "$CURRENT_VERSION" ]; then
            echo "ğŸŸ¢ ç‰ˆæœ¬å·²æ˜¯æœ€æ–°ï¼Œæ— éœ€æ›´æ–°"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… éœ€è¦æ›´æ–°: $CURRENT_VERSION -> $LATEST_RAW"
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Update script version
        if: steps.get-version.outputs.skip == 'false'
        id: update
        run: |
          set -e
          
          LATEST_VERSION="${{ steps.get-version.outputs.latest_version }}"
          CURRENT_VERSION="${{ steps.get-version.outputs.current_version }}"
          NEW_SCRIPT_VERSION="${{ steps.get-version.outputs.new_script_version }}"

          echo "æ­£åœ¨æ›´æ–°è„šæœ¬ç‰ˆæœ¬å·..."

          # å¤‡ä»½åŸæ–‡ä»¶
          cp xwPF.sh xwPF.sh.backup

          # æ›´æ–°REALM_VERSIONå˜é‡
          sed -i "s/^REALM_VERSION=\".*\"/REALM_VERSION=\"$LATEST_VERSION\"/" xwPF.sh

          # æ›´æ–°SCRIPT_VERSIONå˜é‡
          sed -i "s/^SCRIPT_VERSION=\".*\"/SCRIPT_VERSION=\"$NEW_SCRIPT_VERSION\"/" xwPF.sh

          # éªŒè¯æ›´æ–°æ˜¯å¦æˆåŠŸ
          NEW_REALM_VERSION=$(grep '^REALM_VERSION=' xwPF.sh | cut -d'"' -f2)
          NEW_SCRIPT_VERSION_CHECK=$(grep '^SCRIPT_VERSION=' xwPF.sh | cut -d'"' -f2)

          if [ "$NEW_REALM_VERSION" != "$LATEST_VERSION" ] || [ "$NEW_SCRIPT_VERSION_CHECK" != "$NEW_SCRIPT_VERSION" ]; then
            echo "âŒ ç‰ˆæœ¬å·æ›´æ–°å¤±è´¥ï¼Œæ¢å¤åŸæ–‡ä»¶"
            mv xwPF.sh.backup xwPF.sh
            echo "update_success=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # æ¸…ç†å¤‡ä»½æ–‡ä»¶
          rm -f xwPF.sh.backup

          echo "âœ… ç‰ˆæœ¬å·æ›´æ–°æˆåŠŸ: $CURRENT_VERSION -> $LATEST_VERSION"
          echo "âœ… è„šæœ¬ç‰ˆæœ¬æ›´æ–°æˆåŠŸ: $NEW_SCRIPT_VERSION"
          echo "update_success=true" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.get-version.outputs.skip == 'false' && steps.update.outputs.update_success == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "bump: realmç‰ˆæœ¬å·${{ steps.get-version.outputs.latest_version }}"
          title: "bump: realmç‰ˆæœ¬å·${{ steps.get-version.outputs.latest_version }}"
          body: |
            è‡ªåŠ¨æ£€æµ‹åˆ°realmæ–°ç‰ˆæœ¬å‘å¸ƒ
            
            - å½“å‰ç‰ˆæœ¬ï¼š${{ steps.get-version.outputs.current_version }}
            - æœ€æ–°ç‰ˆæœ¬ï¼š${{ steps.get-version.outputs.latest_version }}
            
            æ­¤PRç”±GitHub Actionsè‡ªåŠ¨åˆ›å»ºï¼Œè¯·æ£€æŸ¥ååˆå¹¶ã€‚
          branch: update-realm-${{ steps.get-version.outputs.latest_version }}
          delete-branch: true
          
      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.get-version.outputs.skip }}" = "true" ]; then
            echo "ğŸŸ¢ æœ¬æ¬¡æ£€æŸ¥å®Œæˆï¼Œæ— éœ€æ›´æ–°"
          elif [ "${{ steps.update.outputs.update_success }}" = "true" ]; then
            echo "âœ… æˆåŠŸåˆ›å»ºPRï¼Œç‰ˆæœ¬æ›´æ–°: ${{ steps.get-version.outputs.current_version }} -> ${{ steps.get-version.outputs.latest_version }}"
          else
            echo "âŒ æ›´æ–°è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œä¿æŒåŸçŠ¶"
          fi
